// Prisma Schema for Centralized Delivery Network

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  AGENT
  PARTNER
  ADMIN
}

enum VehicleType {
  BIKE
  SCOOTER
  CAR
  BICYCLE
}

enum AgentStatus {
  OFFLINE
  ONLINE
  ON_TRIP
}

enum PayoutPlan {
  WEEKLY
  MONTHLY
}

enum OrderStatus {
  SEARCHING_AGENT
  ASSIGNED
  PICKED_UP
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
  DELAYED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum EventType {
  AGENT_ONLINE
  AGENT_OFFLINE
  ORDER_CREATED
  ORDER_ASSIGNED
  ORDER_ACCEPTED
  ORDER_REJECTED
  ORDER_PICKED_UP
  ORDER_OUT_FOR_DELIVERY
  ORDER_DELIVERED
  ORDER_CANCELLED
  AGENT_LOCATION_UPDATE
}

enum ActorType {
  AGENT
  PARTNER
  SYSTEM
  ADMIN
}

// Main User table - all authentication
model User {
  id             String    @id @default(cuid())
  name           String
  email          String    @unique
  phone          String    @unique
  passwordHash   String
  role           UserRole
  emailVerified  DateTime?
  phoneVerified  Boolean   @default(false)
  profilePicture String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  agent             Agent?
  partner           Partner?
  notifications     NotificationToken[]
  userNotifications Notification[]
  tickets           SupportTicket[]

  @@index([email])
  @@index([phone])
  @@index([role])
}

// Agent-specific data
model Agent {
  id              String      @id @default(cuid())
  userId          String      @unique
  vehicleType     VehicleType
  status          AgentStatus @default(OFFLINE)
  payoutPlan      PayoutPlan  @default(WEEKLY) // Weekly or Monthly payout plan
  rating          Float?      @default(0)
  totalOrders     Int         @default(0)
  completedOrders Int         @default(0)
  cancelledOrders Int         @default(0)
  acceptanceRate  Float       @default(0) // percentage
  currentOrderId  String?     @unique
  isApproved      Boolean     @default(false)
  isBlocked       Boolean     @default(false)
  blockedReason   String?
  city            String?
  state           String?
  pincode         String?
  lastOnlineAt    DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders          Order[]
  currentOrder    Order?          @relation("CurrentOrder", fields: [currentOrderId], references: [id])
  documents       AgentDocument[]
  locationHistory AgentLocation[]
  tickets         SupportTicket[]
  ratings         AgentRating[]
  wallet          AgentWallet?
  walletPayouts   WalletPayout[]
  payments        Payment[]
  payrolls        Payroll[]
  schedules       AgentSchedule[]

  @@index([status])
  @@index([isApproved])
  @@index([city])
  @@index([status, isApproved, isBlocked]) // Composite index for common query pattern
  @@index([isApproved, createdAt]) // For KYC queries with sorting
}

// Agent documents (license, vehicle registration, etc.)
model AgentDocument {
  id           String   @id @default(cuid())
  agentId      String
  documentType String // LICENSE, VEHICLE_REG, ID_PROOF, etc.
  fileName     String
  fileUrl      String
  verified     Boolean  @default(false)
  uploadedAt   DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([verified]) // Frequently queried in KYC verification
  @@index([documentType]) // Used in document type queries
  @@index([agentId, documentType, verified]) // Composite for document verification queries
}

// Agent location history (optional - for analytics)
model AgentLocation {
  id        String   @id @default(cuid())
  agentId   String
  latitude  Float
  longitude Float
  timestamp DateTime @default(now())

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([agentId, timestamp])
  @@index([timestamp])
}

// Partner-specific data
model Partner {
  id          String   @id @default(cuid())
  userId      String   @unique
  companyName String
  apiKey      String   @unique
  webhookUrl  String?
  isActive    Boolean  @default(true)
  city        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders           Order[]
  tickets          SupportTicket[]
  dailyStats       PartnerDailyStats[]
  agentRatings     AgentRating[]
  partnerRevenues  PartnerRevenue[]
  platformRevenues PlatformRevenue[]

  @@index([apiKey])
  @@index([isActive])
}

// Orders
model Order {
  id                 String      @id @default(cuid())
  partnerId          String
  agentId            String?
  pickupLat          Float
  pickupLng          Float
  dropLat            Float
  dropLng            Float
  payoutAmount       Float // Amount paid to agent (base payment)
  orderAmount        Float? // Total amount partner charges customer (for revenue calculation)
  platformFee        Float? // Platform commission/fee percentage or amount
  orderType          String?     @default("ON_DEMAND") // ON_DEMAND, B2B_BULK
  commissionRate     Float? // Commission percentage applied (15-30% for ON_DEMAND, 8-12% for B2B_BULK)
  priority           String?     @default("NORMAL") // HIGH, NORMAL, LOW
  status             OrderStatus @default(SEARCHING_AGENT)
  assignedAt         DateTime?
  pickedUpAt         DateTime?
  deliveredAt        DateTime?
  cancelledAt        DateTime?
  cancellationReason String?
  estimatedDuration  Int? // in minutes
  actualDuration     Int? // in minutes
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  // Barcode/QR Code fields
  barcode String? @unique // Barcode for scanning
  qrCode  String? @unique // QR code for scanning

  // Delivery verification fields
  deliveryOtp        String?   @unique // OTP for delivery verification
  deliveryQrCode     String?   @unique // QR code for delivery verification
  otpExpiresAt       DateTime? // OTP expiration time
  verifiedAt         DateTime? // When delivery was verified by customer
  verificationMethod String? // OTP, QR_CODE, SIGNATURE

  // Relations
  partner            Partner             @relation(fields: [partnerId], references: [id])
  agent              Agent?              @relation(fields: [agentId], references: [id])
  currentAgent       Agent?              @relation("CurrentOrder")
  tickets            SupportTicket[]
  rating             AgentRating?
  payments           Payment[]
  partnerRevenue     PartnerRevenue?
  platformRevenue    PlatformRevenue?
  walletTransactions WalletTransaction[]

  @@index([partnerId])
  @@index([agentId])
  @@index([status])
  @@index([createdAt])
  @@index([priority]) // Used in order prioritization
  @@index([partnerId, status])
  @@index([status, agentId]) // For agent order queries
  @@index([status, createdAt]) // For sorting orders by status and date
  @@index([barcode]) // For barcode scanning
  @@index([qrCode]) // For QR code scanning
  @@index([deliveryOtp]) // For OTP verification
  @@index([deliveryQrCode]) // For QR verification
}

// FCM notification tokens
model NotificationToken {
  id         String   @id @default(cuid())
  userId     String
  fcmToken   String   @unique
  deviceType String? // IOS, ANDROID, WEB
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([fcmToken])
}

// Support tickets
model SupportTicket {
  id          String       @id @default(cuid())
  orderId     String?
  agentId     String?
  partnerId   String?
  userId      String
  issueType   String // DELAY, MISSING, DAMAGE, OTHER
  description String
  status      TicketStatus @default(OPEN)
  resolvedAt  DateTime?
  adminNotes  String? // Admin comments/notes when resolving or closing
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  order   Order?   @relation(fields: [orderId], references: [id])
  agent   Agent?   @relation(fields: [agentId], references: [id])
  partner Partner? @relation(fields: [partnerId], references: [id])
  user    User     @relation(fields: [userId], references: [id])

  @@index([orderId])
  @@index([agentId])
  @@index([partnerId])
  @@index([status])
}

// Analytics events
model AppEvent {
  id         String    @id @default(cuid())
  userId     String?
  actorType  ActorType
  eventType  EventType
  entityType String? // ORDER, AGENT, PARTNER
  entityId   String?
  metadata   Json? // Additional event data
  createdAt  DateTime  @default(now())

  @@index([eventType])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([actorType])
}

// Daily aggregated stats (optional - for performance)
model DailyStats {
  id                String   @id @default(cuid())
  date              DateTime @unique @db.Date
  totalOrders       Int      @default(0)
  completedOrders   Int      @default(0)
  cancelledOrders   Int      @default(0)
  activeAgents      Int      @default(0)
  avgAssignmentTime Float? // in seconds
  totalPayout       Float    @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([date])
}

// Partner-specific daily stats
model PartnerDailyStats {
  id                String   @id @default(cuid())
  partnerId         String
  date              DateTime @db.Date
  totalOrders       Int      @default(0)
  completedOrders   Int      @default(0)
  cancelledOrders   Int      @default(0)
  avgAssignmentTime Float?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@unique([partnerId, date])
  @@index([partnerId, date])
}

// Partner Revenue Model - Track partner earnings from orders
model PartnerRevenue {
  id          String    @id @default(cuid())
  partnerId   String
  orderId     String    @unique
  orderAmount Float // Amount partner charges customer
  deliveryFee Float // Amount paid to agent
  platformFee Float // Platform commission/fee
  netRevenue  Float // orderAmount - deliveryFee - platformFee
  status      String    @default("PENDING") // PENDING, PROCESSED, FAILED
  processedAt DateTime?
  periodStart DateTime  @db.Date // For aggregation (daily/weekly/monthly)
  periodEnd   DateTime  @db.Date
  periodType  String // DAILY, WEEKLY, MONTHLY
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([orderId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([createdAt])
}

// Platform Revenue Model - Track platform earnings (commissions, fees)
model PlatformRevenue {
  id          String    @id @default(cuid())
  orderId     String    @unique
  partnerId   String
  agentId     String?
  orderAmount Float // Total order value
  platformFee Float // Platform commission/fee from partner
  agentPayout Float // Amount paid to agent
  netRevenue  Float // platformFee (platform keeps this)
  revenueType String // COMMISSION, SERVICE_FEE, SUBSCRIPTION
  status      String    @default("PENDING") // PENDING, PROCESSED, FAILED
  processedAt DateTime?
  periodStart DateTime  @db.Date // For aggregation
  periodEnd   DateTime  @db.Date
  periodType  String // DAILY, WEEKLY, MONTHLY
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([partnerId])
  @@index([agentId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([revenueType])
  @@index([createdAt])
}

// Admin Wallet - Platform's main wallet (stores all platform revenue)
model AdminWallet {
  id             String   @id @default(cuid())
  balance        Float    @default(0) // Current balance
  totalDeposited Float    @default(0) // Total money received
  totalPaidOut   Float    @default(0) // Total money paid to agents
  lastUpdated    DateTime @default(now()) @updatedAt
  createdAt      DateTime @default(now())

  transactions WalletTransaction[]

  @@index([lastUpdated])
}

// Agent Wallet - Stores agent earnings (pending payout)
model AgentWallet {
  id             String    @id @default(cuid())
  agentId        String    @unique
  balance        Float     @default(0) // Current pending balance
  totalEarned    Float     @default(0) // Total earnings (all time)
  totalPaidOut   Float     @default(0) // Total paid out
  lastPayoutDate DateTime? // Last payout date
  nextPayoutDate DateTime? // Next scheduled payout date
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  agent        Agent               @relation(fields: [agentId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]
  payouts      WalletPayout[]

  @@index([agentId])
  @@index([nextPayoutDate])
  @@index([lastPayoutDate])
}

// Wallet Transactions - Track all wallet movements
model WalletTransaction {
  id            String   @id @default(cuid())
  walletType    String // ADMIN_WALLET, AGENT_WALLET
  adminWalletId String?
  agentWalletId String?
  orderId       String? // Related order if applicable
  amount        Float // Transaction amount (positive = credit, negative = debit)
  type          String // DEPOSIT, WITHDRAWAL, PAYOUT, COMMISSION, EARNING
  description   String? // Transaction description
  balanceBefore Float // Balance before transaction
  balanceAfter  Float // Balance after transaction
  status        String   @default("COMPLETED") // COMPLETED, PENDING, FAILED
  createdAt     DateTime @default(now())

  adminWallet AdminWallet? @relation(fields: [adminWalletId], references: [id], onDelete: Cascade)
  agentWallet AgentWallet? @relation(fields: [agentWalletId], references: [id], onDelete: Cascade)
  order       Order?       @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@index([walletType])
  @@index([adminWalletId])
  @@index([agentWalletId])
  @@index([orderId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

// Wallet Payouts - Track agent payouts (weekly payouts)
model WalletPayout {
  id            String    @id @default(cuid())
  agentWalletId String
  agentId       String
  amount        Float // Payout amount
  periodStart   DateTime  @db.Date // Week start date
  periodEnd     DateTime  @db.Date // Week end date
  status        String    @default("PENDING") // PENDING, PROCESSED, FAILED, CANCELLED
  paymentMethod String? // BANK_TRANSFER, UPI, MOBILE_MONEY
  transactionId String? // External transaction ID
  bankAccount   String? // Agent's bank account details (JSON)
  upiId         String? // Agent's UPI ID
  processedAt   DateTime?
  failedAt      DateTime?
  failureReason String?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  agentWallet AgentWallet @relation(fields: [agentWalletId], references: [id], onDelete: Cascade)
  agent       Agent       @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, periodStart, periodEnd])
  @@index([agentId])
  @@index([agentWalletId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([createdAt])
}

// In-app notifications
model Notification {
  id        String    @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String // ORDER, SYSTEM, SUPPORT, etc.
  isRead    Boolean   @default(false)
  link      String? // Optional link to related page
  metadata  Json? // Additional data
  createdAt DateTime  @default(now())
  readAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@index([createdAt])
  @@index([type])
}

// Agent ratings and reviews
model AgentRating {
  id        String   @id @default(cuid())
  orderId   String   @unique
  agentId   String
  partnerId String
  rating    Int // 1-5 stars
  comment   String? // Optional review comment
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  agent   Agent   @relation(fields: [agentId], references: [id], onDelete: Cascade)
  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([partnerId])
  @@index([orderId])
  @@index([createdAt])
}

// Payment records for agent earnings
model Payment {
  id            String    @id @default(cuid())
  agentId       String
  orderId       String
  amount        Float // Payment amount
  paymentType   String // DELIVERY_FEE, BONUS, PENALTY, etc.
  status        String    @default("PENDING") // PENDING, PROCESSED, FAILED
  processedAt   DateTime?
  paymentMethod String? // BANK_TRANSFER, MOBILE_MONEY, CASH, etc.
  transactionId String? // External transaction ID
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([orderId])
  @@index([status])
  @@index([createdAt])
  @@index([agentId, status])
}

// Payroll records (aggregated payments at end of day/week)
model Payroll {
  id            String    @id @default(cuid())
  agentId       String
  periodStart   DateTime  @db.Date
  periodEnd     DateTime  @db.Date
  periodType    String // DAILY, WEEKLY, MONTHLY
  totalEarnings Float     @default(0)
  totalOrders   Int       @default(0)
  basePay       Float     @default(0) // Base pay from completed orders
  bonuses       Float     @default(0) // Bonuses
  deductions    Float     @default(0) // Deductions/penalties
  netPay        Float     @default(0) // Net pay after deductions
  status        String    @default("PENDING") // PENDING, PROCESSED, PAID, FAILED
  processedAt   DateTime?
  paidAt        DateTime?
  paymentMethod String? // BANK_TRANSFER, MOBILE_MONEY, etc.
  transactionId String? // External transaction ID
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, periodStart, periodEnd, periodType])
  @@index([agentId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([agentId, periodStart, periodEnd])
}

// Agent schedule and availability
model AgentSchedule {
  id          String   @id @default(cuid())
  agentId     String
  date        DateTime @db.Date
  startTime   String? // HH:mm format
  endTime     String? // HH:mm format
  isAvailable Boolean  @default(true)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, date])
  @@index([agentId])
  @@index([date])
  @@index([agentId, date, isAvailable])
}

// Pay structure configuration
model PayStructure {
  id             String    @id @default(cuid())
  name           String // Structure name (e.g., "Standard", "Premium")
  payType        String // PER_DELIVERY, HOURLY, SALARY, COMMISSION
  baseRate       Float? // Base rate (per delivery or per hour)
  commissionRate Float? // Commission percentage (0-100)
  minGuarantee   Float? // Minimum guaranteed pay
  maxLimit       Float? // Maximum pay limit
  bonusRules     Json? // Bonus calculation rules
  deductionRules Json? // Deduction rules
  isActive       Boolean   @default(true)
  effectiveFrom  DateTime  @default(now())
  effectiveTo    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([isActive])
  @@index([effectiveFrom, effectiveTo])
}
